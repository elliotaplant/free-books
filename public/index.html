<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book Search</title>
    <link rel="stylesheet" href="https://unpkg.com/mvp.css" />
    <style>
      .book-card {
        border: 1px solid #cccccc;
        padding: 1em;
        margin-bottom: 1em;
        border-radius: 8px;
        background-color: #f9f9f9;
      }

      .book-card h2 {
        margin-top: 0;
      }

      .pagination {
        justify-content: space-between;
        font-size: 1.2em;
        display: none;
        margin: 1em 0;
      }

      .pagination button {
        margin: 0 0.5em;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Book Search</h1>

      <form>
        <label for="kindle-email-input">Kindle Email</label>
        <input
          type="text"
          id="kindle-email-input"
          placeholder="you@kindle.com"
        />
      </form>
      <br />
      <form id="search-form">
        <input type="text" id="title-input" placeholder="Title" />
        <input type="text" id="author-input" placeholder="Author" />
        <button type="submit">Search</button>
      </form>
    </header>
    <main id="results-section">
      <!-- Search results will be appended here -->
    </main>
    <div class="pagination">
      <button id="prev-page" disabled>Prev</button>
      <button id="next-page" disabled>Next</button>
    </div>
    <script>
      let currentPage = 1;

      document
        .getElementById('search-form')
        .addEventListener('submit', async (event) => {
          event.preventDefault();

          const title = document.getElementById('title-input').value;
          const author = document.getElementById('author-input').value;

          await searchBooks(title, author, 1);
        });

      document
        .getElementById('prev-page')
        .addEventListener('click', async () => {
          const title = document.getElementById('title-input').value;
          const author = document.getElementById('author-input').value;

          await searchBooks(title, author, currentPage - 1);
        });

      document
        .getElementById('next-page')
        .addEventListener('click', async () => {
          const title = document.getElementById('title-input').value;
          const author = document.getElementById('author-input').value;

          await searchBooks(title, author, currentPage + 1);
        });

      async function searchBooks(title, author, page) {
        const response = await fetch('/query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ title, author, page }),
        });

        if (response.ok) {
          const results = await response.json();
          displayResults(results);
          currentPage = page;
          document.getElementById('prev-page').disabled = currentPage === 1;
          document.getElementById('next-page').disabled = results.length < 10;
          document.querySelector('.pagination').style.display = 'flex';
        } else {
          const error = await response.text();
          displayError(error);
        }
      }

      function displayResults(results) {
        const resultsSection = document.getElementById('results-section');
        resultsSection.innerHTML = '';

        if (results.length === 0) {
          resultsSection.textContent = 'No results found';
          return;
        }

        results.forEach((book) => {
          const filesizeKB = book.Filesize / 1024;
          const displayFilesize =
            filesizeKB < 1024
              ? `${Math.round(filesizeKB)} KB`
              : `${Math.round(filesizeKB / 1024)} MB`;

          const bookCard = document.createElement('div');

          bookCard.className = 'book-card'; // Added a class name to the card for styling
          bookCard.innerHTML = `
                        <h2>${book.Title}</h2>
                        <h3>${book.Author}</h3>
                        <p>${displayFilesize}</p>
                        <button
                          class="send-to-kindle"
                          data-md5="${book.MD5}"
                          onclick="sendToKindle('${book.MD5}')"
                        >
                          Send to Kindle
                        </button>


                    `;
          resultsSection.appendChild(bookCard);
        });
      }

      function displayError(error) {
        const resultsSection = document.getElementById('results-section');
        resultsSection.textContent = `An error occurred: ${error}`;
        document.querySelector('.pagination').style.display = 'none';
      }

      async function sendToKindle(md5) {
        const email = document.getElementById('kindle-email-input').value;
        if (!email) {
          alert('You must set a Kindle email first');
          return;
        }

        const response = await fetch('/send-to-kindle', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, md5 }),
        });

        if (response.ok) {
          alert('Book sent to Kindle');
        } else {
          const error = await response.text();
          alert(`An error occurred: ${error}`);
        }
      }

      document
        .getElementById('kindle-email-input')
        .addEventListener('input', (event) => {
          localStorage.setItem('kindle-email', event.target.value);
        });

      window.addEventListener('load', () => {
        const email = localStorage.getItem('kindle-email');
        if (email) {
          document.getElementById('kindle-email-input').value = email;
        }
      });
    </script>
  </body>
</html>
