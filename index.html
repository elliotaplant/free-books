<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Free Books</title>
    <style media="screen">
      * {
        font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir, roboto, noto, segoe ui, arial, sans-serif;
      }

      .cover {
        width: 5vw;
      }

      label {
        display: block;
      }

      input {
        margin-bottom: 1em;
        width: 100%;
        max-width: 20em;
      }

      table {
        border-collapse: collapse;
        width: 100%;
      }

      thead {
        border-bottom: 1px solid #f2f2f2;
      }

      th, td {
        text-align: left;
        padding: 8px;
      }

      tr:nth-child(even) {
        background-color: #f2f2f2;
      }
    </style>
  </head>
  <body>
    <h1>Free Books</h1>
    <p>
      Before using this app, register the email free.books.sender@gmail.com in your Amazon Kindle
      <a href="addEmail">devices page</a>
    </p>
    <form onsubmit="query(event)">
      <label>Kindle Email (<a href="addEmail">what is this?</a>)</label>
      <input id="kindleEmailInput" placeholder="youremailaddress@kindle.com" required>

      <br>

      <label>Book Search</label>
      <input id="queryInput" required>
      <button id="queryBtn">Search</button>
    </form>
    <div id="errDiv" style="color: red"></div>

    <table id="resultsTable" style="display: none">
      <thead><th>Cover</th><th>Title</th><th>Author</th><th>Language</th><th>Extension</th><th>Size</th><th /></thead>
      <tbody id="resultsTableBody"></tbody>
    </table>

    <script type="text/javascript">
      const IMG_PROXY_PREFIX = '/.netlify/functions/imgProxy?url=http://libgen.is/covers/';
      const MIRROR = 'http://libgen.is';
      const KINDLE_EMAIL_KEY = 'kindleEmail';

      let kindleEmail = localStorage.getItem(KINDLE_EMAIL_KEY)
      kindleEmailInput.value = kindleEmail;

      kindleEmailInput.onkeyup = () => {
        localStorage.setItem(KINDLE_EMAIL_KEY, kindleEmailInput.value);
        kindleEmail = kindleEmailInput.value;
      }

      function query(event) {
        event.preventDefault();
        queryBtn.disabled = true;
        queryBtn.innerText = 'Searching';

        fetch('/.netlify/functions/query', {
          method: 'POST',
          body: JSON.stringify({ query: queryInput.value }),
        })
          .then(r => r.json())
          .then(queryResponse => {
            resultsTable.style.display = 'block';
            if (!Array.isArray(queryResponse)) {
              resultsTableBody.innerHTML = '<td>No Results</td>'
              return;
            }
            resultsTableBody.innerHTML = queryResponse.map(qr => `
              <td><img class="cover" src="${IMG_PROXY_PREFIX + qr.coverurl}" /></td>
              ${[qr.title, qr.author, qr.language, qr.extension].map(datum => `<td>${datum}</td>`).join('\n')}
              <td>${(Number(qr.filesize) / 10e6).toFixed(2)} Mb</td>
              <td>
                <span class="loading"></span>
                <button onclick="requestBook(event)" data-md5=${qr.md5}>
                  Send to Kindle
                </button>
              </td>
            `).map(row => `<tr>${row}</tr>`).join('\n')
          })
          .catch(e => {
            errDiv.innerText = e.toString();
          })
          .finally(() => {
            queryBtn.disabled = null;
            queryBtn.innerText = 'Search';
          })
      }

      function requestBook(event) {
        const btn = event.target;
        const { md5 } = btn.dataset;
        const loadingDiv = btn.parentElement.querySelector('.loading');
        btn.disabled = true;
        btn.innerText = 'Sending to Kindle';

        fetch('/.netlify/functions/createJob', {
          method: 'POST',
          body: JSON.stringify({ email: kindleEmail, md5 })
        }).then(() => {
          btn.style.display = 'none';
          loadingDiv.innerText = 'Sent book to your Kindle. Expect it to arrive in less than five minutes';
        })
        .catch(e => {
          errDiv.innerText = e.toString();
          btn.innerText = 'Something went wrong :(';
        })
      }
    </script>
  </body>
</html>
