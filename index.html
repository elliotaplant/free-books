<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Free Books</title>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  </head>
  <body>
    <h1>Hello, world!</h1>
    <input id="queryInput" >
    <button type="button" id="queryBtn">Search</button>
    <button type="button" id="btn">Send a book</button>
    <button type="button" id="exampleBtn">Trigger Example</button>
    <div id="errDiv" style="color: red"></div>

    <div data-netlify-identity-button></div>
    <table>
      <thead>
        <th>Cover</th>
        <th>Title</th>
        <th>Author</th>
        <th>language</th>
        <th>md5</th>
      </thead>
      <tbody id="resultsTableBody"></tbody>
    </table>
    <script type="text/javascript">
      const IMG_PROXY_PREFIX = '/.netlify/functions/imgProxy?url=http://libgen.is/covers/';

      btn.onclick = () => {
        fetch('/.netlify/functions/mailBook', {
          method: 'POST',
          body: JSON.stringify({
            email: 'elliotaplant@kindle.com',
            filename: 'AtomicHabits.mobi',
            url: 'http://111.90.145.72/get.php?md5=8c73124490c686f19d6bb694e836b92f&key=HEAMFWWY8F0HYSDP&mirr=1',
          }
        )})
          .catch(e => {
            errDiv.innerText = e.toString();
          })
      }

      queryBtn.onclick = () => {
        fetch('/.netlify/functions/query', {
          method: 'POST',
          body: JSON.stringify({ query: queryInput.value }),
        })
          .then(r => r.json())
          .then(queryResponse => console.log('queryResponse', queryResponse) || queryResponse)
          .then(queryResponse => {
            resultsTableBody.innerHTML = queryResponse.map(qr => `
              <td><img src="${IMG_PROXY_PREFIX + qr.coverurl}" /></td>
              ${[qr.title, qr.author, qr.language].map(datum => `<td>${datum}</td>`).join('\n')}
              <td><button onclick="requestBook()" data-md5=${qr.md5}>Send to Kindle</button></td>
            `).map(row => `<tr>${row}</tr>`).join('\n')
          })
          .catch(e => {
            errDiv.innerText = e.toString();
          })
      }

      function requestBook(event) {
        console.log('event', event);
      }

      exampleBtn.onclick = () => {
        return netlifyIdentity.currentUser().jwt()
          .then(token => ({ Authorization: `Bearer ${token}` }))
          .then(headers => fetch('/.netlify/functions/example', { headers }))
          .then(r => r.json())
          .then(console.log)
          .catch(e => {
            errDiv.innerText = e.toString();
          });
      }
    </script>
  </body>
</html>
