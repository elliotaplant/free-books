<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Free Books</title>
    <style media="screen">
      * {
        font-family: -apple-system, BlinkMacSystemFont, avenir next, avenir, roboto, noto, segoe ui, arial, sans-serif;
      }

      .cover {
        width: 5vw;
      }
    </style>
  </head>
  <body>
    <h1>Free Books</h1>
    <p>Register the email freebookssender@gmail.com in your Amazon kindle devices page</p>
    <div>
      <input id="kindleEmailInput" >
    </div>
    <div>
      <input id="queryInput" >
      <button type="button" id="queryBtn">Search</button>
    </div>
    <div id="errDiv" style="color: red"></div>

    <table id="resultsTable" style="display: none">
      <thead><th>Cover</th><th>Title</th><th>Author</th><th>Language</th><th>Extension</th><th /></thead>
      <tbody id="resultsTableBody"></tbody>
    </table>

    <script type="text/javascript">
      const IMG_PROXY_PREFIX = '/.netlify/functions/imgProxy?url=http://libgen.is/covers/';
      const MIRROR = 'http://libgen.is';
      const KINDLE_EMAIL_KEY = 'kindleEmail';

      let kindleEmail = localStorage.getItem(KINDLE_EMAIL_KEY)
      kindleEmailInput.value = kindleEmail;

      kindleEmailInput.onkeyup = () => {
        localStorage.setItem(KINDLE_EMAIL_KEY, kindleEmailInput.value);
        kindleEmail = kindleEmailInput.value;
      }

      queryBtn.onclick = () => {
        fetch('/.netlify/functions/query', {
          method: 'POST',
          body: JSON.stringify({ query: queryInput.value }),
        })
          .then(r => r.json())
          .then(queryResponse => {
            resultsTable.style.display = 'block';
            resultsTableBody.innerHTML = queryResponse.map(qr => `
              <td><img class="cover" src="${IMG_PROXY_PREFIX + qr.coverurl}" /></td>
              ${[qr.title, qr.author, qr.language, qr.extension].map(datum => `<td>${datum}</td>`).join('\n')}
              <td>${(Number(qr.filesize) / 10e6).toFixed(2)} Mb</td>
              <td>
                <button onclick="requestBook(event)" data-md5=${qr.md5}>
                  Send to Kindle
                </button>
              </td>
            `).map(row => `<tr>${row}</tr>`).join('\n')
          })
          .catch(e => {
            errDiv.innerText = e.toString();
          })
      }

      function requestBook(event) {
        const { md5 } = event.target.dataset;
        fetch('/.netlify/functions/createJob', {
          method: 'POST',
          body: JSON.stringify({ email: kindleEmail, md5 })
        })
      }
    </script>
  </body>
</html>
